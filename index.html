<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ù†Ø¸Ø§Ù… Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥ÙØ·Ø§Ø± | Ù…Ø¯Ø±Ø³Ø© Ø¹Ø§Ø¦Ø´Ø© Ø¨Ù†Øª Ø·Ù„Ø­Ø©</title>

<!-- PDF (ØªØ­ÙˆÙŠÙ„ HTML Ø¥Ù„Ù‰ PDF) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<!-- QR -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

<style>
  :root{
    --bg:#f4f6fb;
    --card:#fff;
    --ink:#0f172a;
    --muted:#475569;
    --pri:#2563eb;
    --ok:#16a34a;
    --bad:#dc2626;
    --line:#e2e8f0;
    --shadow:0 10px 25px rgba(0,0,0,.08);
    --rad:14px;
  }
  body{margin:0;font-family:Tahoma,Arial;background:var(--bg);color:var(--ink)}
  header{
    background:linear-gradient(90deg,#1e3a8a,#2563eb);
    color:#fff;padding:16px;text-align:center
  }
  header h2{margin:0 0 4px;font-size:20px}
  header .sub{opacity:.9;font-size:13px}
  .container{max-width:1200px;margin:auto;padding:14px}
  .grid{display:grid;gap:12px}
  @media(min-width:980px){.grid{grid-template-columns:1.05fr .95fr}}
  .card{
    background:var(--card);border:1px solid var(--line);
    border-radius:var(--rad);padding:14px;box-shadow:var(--shadow)
  }
  h3{margin:0 0 10px;font-size:16px}
  .hint{color:var(--muted);font-size:13px;line-height:1.6}
  label{display:block;margin-top:10px;color:var(--muted);font-size:13px}
  input,select,textarea{
    width:100%;padding:10px;border:1px solid var(--line);
    border-radius:10px;margin-top:6px;font-size:14px;outline:none
  }
  textarea{min-height:110px;resize:vertical}
  .row{display:grid;gap:10px}
  @media(min-width:720px){.row.two{grid-template-columns:1fr 1fr}}
  @media(min-width:720px){.row.three{grid-template-columns:1fr 1fr 1fr}}
  .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  button{
    padding:10px 14px;border:0;border-radius:10px;cursor:pointer;
    font-size:14px;font-weight:700
  }
  .primary{background:var(--pri);color:#fff}
  .success{background:var(--ok);color:#fff}
  .danger{background:var(--bad);color:#fff}
  .ghost{background:#eef2ff;color:#1e3a8a;border:1px solid #c7d2fe}
  .pill{
    display:inline-flex;gap:8px;align-items:center;
    border:1px dashed var(--line);border-radius:999px;padding:8px 12px;
    background:#f8fafc;color:var(--muted);font-size:13px
  }
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border:1px solid var(--line);padding:8px;text-align:center;font-size:13px}
  th{background:#f1f5f9}
  .summary{
    display:flex;gap:10px;flex-wrap:wrap;margin-top:10px
  }
  .summary .box{
    flex:1;min-width:160px;background:#f8fafc;border:1px solid var(--line);
    border-radius:12px;padding:10px;text-align:center
  }
  .summary .box b{display:block;font-size:18px}
  .split{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start}
  .qrBox{border:1px solid var(--line);border-radius:12px;padding:12px;background:#f8fafc}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
  .lock{border:1px solid #fecaca;background:#fff1f2;color:#7f1d1d;padding:10px;border-radius:12px}
  .okBox{border:1px solid #bbf7d0;background:#f0fdf4;color:#14532d;padding:10px;border-radius:12px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .tab{padding:9px 12px;border:1px solid var(--line);border-radius:12px;background:#f8fafc;cursor:pointer}
  .tab.active{border-color:#93c5fd;background:#eef2ff;color:#1e3a8a;font-weight:800}
  .hr{height:1px;background:var(--line);margin:12px 0}
  .small{font-size:12px}
  select[multiple]{min-height:120px}

  .multiWrap{position:relative}
  .multiBtn{width:100%;text-align:right;background:#fff;border:1px solid var(--line);padding:10px;border-radius:10px;cursor:pointer;font-size:14px}
  .multiPanel{position:absolute;z-index:50;left:0;right:0;top:calc(100% + 6px);background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);max-height:280px;overflow:auto;padding:8px;display:none}
  .multiRow{display:flex;align-items:center;gap:10px;padding:8px;border-radius:10px}
  .multiRow:hover{background:#f8fafc}
  .multiRow .ck{width:16px;height:16px;flex:0 0 auto}
  .multiRow .ttl{flex:1;min-width:140px;font-size:13px}
  .multiRow .desc{display:block;color:var(--muted);font-size:12px;margin-top:2px}
  .multiRow .qtySel{width:90px;max-width:90px;padding:8px;margin-top:0}
</style>
</head>

<body>
<header>
  <h2>Ù†Ø¸Ø§Ù… Ù…ØªØ§Ø¨Ø¹Ø© Ø·Ù„Ø¨Ø§Øª ÙˆØ¬Ø¨Ø© Ø§Ù„Ø¥ÙØ·Ø§Ø±</h2>
  <div class="sub">Ù…Ø¯Ø±Ø³Ø© Ø¹Ø§Ø¦Ø´Ø© Ø¨Ù†Øª Ø·Ù„Ø­Ø© â€¢ Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØµÙØ­</div>
</header>

<div class="container">
  <div class="grid">

    <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø·Ø§Ù„Ø¨Ø© -->
    <div class="card">
      <h3>ğŸ§• Ø·Ù„Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨Ø©</h3>
      <div class="pill" id="gatePill">â±ï¸ ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙˆÙ‚Øªâ€¦</div>
      <div class="hint" style="margin-top:8px">
        âœ… Ø§Ù„Ø·Ù„Ø¨ Ù…Ø³Ù…ÙˆØ­ Ù‚Ø¨Ù„ <b class="mono" id="deadlineShow">09:00</b> ØµØ¨Ø§Ø­Ù‹Ø§.
        <br>âš ï¸ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø¬Ù‡Ø§Ø².
      </div>

      <div class="row three" style="margin-top:12px">
        <div>
          <label>Ø§Ù„ØµÙ</label>
          <select id="gradeSel">
            <option value="">â€” Ø§Ø®ØªØ± Ø§Ù„ØµÙ â€”</option>
          </select>
        </div>
        <div>
          <label>Ø§Ù„Ø´Ø¹Ø¨Ø©</label>
          <select id="sectionSel" disabled>
            <option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø© â€”</option>
          </select>
        </div>
        <div>
          <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨Ø©</label>
          <select id="studentSel" disabled>
            <option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ø§Ø³Ù… â€”</option>
          </select>
          <div class="hint small">Ø¥Ø°Ø§ Ù„Ù… ØªØ¸Ù‡Ø± Ø§Ù„Ø£Ø³Ù…Ø§Ø¡: Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±ÙØ© â†’ Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª â†’ Ø§Ø³ØªÙŠØ±Ø§Ø¯/Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.</div>
        </div>
      </div>

      <div class="row two">
        <div>
          <label>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØ¬Ø¨Ø§Øª (ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† ØµÙ†Ù)</label>
          <div class="multiWrap" id="mealsWrap">
            <button type="button" class="multiBtn" id="mealsBtn">â€” Ø§Ø®ØªØ± Ø§Ù„ÙˆØ¬Ø¨Ø§Øª â€”</button>
            <div class="multiPanel" id="mealsPanel"></div>
          </div>
          <div class="hint small">Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª Ø«Ù… Ø­Ø¯Ø¯ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ© (1â€“10) Ù„ÙƒÙ„ ØµÙ†Ù.</div>
        </div>
        <div>
          <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
          <textarea id="note" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ø¯ÙˆÙ† Ø¬Ø¨Ù† / Ø­Ø³Ø§Ø³ÙŠØ©..."></textarea>
        </div>
      </div>

      <div class="btnRow">
        <button class="success" id="btnOrder">âœ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
        <button class="ghost" id="btnClear">â†©ï¸ Ù…Ø³Ø­</button>
      </div>

      <div style="margin-top:12px" id="myOrderBox" class="hint">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨ Ù…Ø³Ø¬Ù„ Ø¨Ø¹Ø¯.</div>
    </div>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±ÙØ© -->
    <div class="card">
      <h3>ğŸ‘©â€ğŸ« Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±ÙØ©</h3>

      <div id="adminLock" class="lock">
        ğŸ”’ Ø§Ù„Ù„ÙˆØ­Ø© Ù…Ù‚ÙÙ„Ø©. Ø§Ø¶ØºØ·ÙŠ â€œÙØªØ­ Ø§Ù„Ù„ÙˆØ­Ø©â€ ÙˆØ£Ø¯Ø®Ù„ÙŠ Ø±Ù…Ø² Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.
      </div>

      <div class="btnRow" style="margin-top:10px">
        <button class="primary" id="btnUnlock">ğŸ”“ ÙØªØ­ Ø§Ù„Ù„ÙˆØ­Ø©</button>
        <button class="ghost" id="btnLock">ğŸ”’ Ù‚ÙÙ„</button>
      </div>

      <div id="adminArea" style="display:none; margin-top:12px">
        <div class="tabs">
          <div class="tab active" data-tab="dash">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
          <div class="tab" data-tab="students">Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª</div>
          <div class="tab" data-tab="meals">Ø§Ù„ÙˆØ¬Ø¨Ø§Øª</div>
          <div class="tab" data-tab="qr">QR / ÙˆØ§ØªØ³Ø§Ø¨</div>
          <div class="tab" data-tab="settings">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
        </div>

        <div class="hr"></div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
        <div id="tab_dash">
          <div class="summary">
            <div class="box"><b id="kpiTotal">0</b><span class="hint">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…</span></div>
            <div class="box"><b id="kpiItems">0</b><span class="hint">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</span></div>
            <div class="box"><b id="kpiTop">â€”</b><span class="hint">Ø§Ù„Ø£ÙƒØ«Ø± Ø·Ù„Ø¨Ù‹Ø§</span></div>
          </div>

          <div class="btnRow" style="margin-top:12px">
            <button class="primary" id="btnMakePdf">ğŸ§¾ Ø¥Ù†Ø´Ø§Ø¡ PDF Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…</button>
            <button class="success" id="btnShareWA">ğŸ“² Ù…Ø´Ø§Ø±ÙƒØ© PDF Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ Ù…Ø¨Ø§Ø´Ø±Ø©</button>
            <button class="danger" id="btnClearToday">ğŸ§¹ Ù…Ø³Ø­ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…</button>
          </div>

          <table id="ordersTable">
            <thead>
              <tr>
                <th>#</th><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ø·Ø§Ù„Ø¨Ø©</th><th>Ø§Ù„ØµÙ</th><th>Ø§Ù„Ø´Ø¹Ø¨Ø©</th><th>Ø§Ù„ÙˆØ¬Ø¨Ø§Øª</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>

          <div class="hint" style="margin-top:10px">
            âœ… Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨:
            <br>â€¢ Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ: ÙŠØ­Ø§ÙˆÙ„ Ù…Ø´Ø§Ø±ÙƒØ© Ù…Ù„Ù PDF Ù…Ø¨Ø§Ø´Ø±Ø©.
            <br>â€¢ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±: ÙŠÙ†Ø²Ù‘Ù„ PDF Ø«Ù… ÙŠÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ ÙˆÙŠØ¨ Ø¨Ø±Ø³Ø§Ù„Ø© Ø¬Ø§Ù‡Ø²Ø© ÙˆØªÙ‚ÙˆÙ…ÙŠÙ† Ø¨Ø¥Ø±ÙØ§Ù‚ Ø§Ù„Ù…Ù„Ù ÙŠØ¯ÙˆÙŠÙ‹Ø§.
          </div>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª -->
        <div id="tab_students" style="display:none">
          <div class="hint">
            Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (CSV): <span class="mono">name,grade,section</span><br>
            Ù…Ø«Ø§Ù„: <span class="mono">Ø¢Ù…Ù†Ø© Ø§Ù„Ù‡Ù†Ø§Ø¦ÙŠØ©,Ø§Ù„Ø³Ø§Ø¨Ø¹,Ø£</span>
          </div>

          <div class="row two" style="margin-top:10px">
            <div>
              <label>Ø±ÙØ¹ Ù…Ù„Ù CSV</label>
              <input type="file" id="csvFile" accept=".csv,text/csv">
            </div>
            <div>
              <label>Ø£Ùˆ Ù„ØµÙ‚ CSV Ù‡Ù†Ø§</label>
              <textarea id="csvPaste" placeholder="name,grade,section&#10;..."></textarea>
            </div>
          </div>

          <div class="btnRow">
            <button class="success" id="btnImportCsv">âœ… Ø§Ø³ØªÙŠØ±Ø§Ø¯/Ø¯Ù…Ø¬</button>
            <button class="ghost" id="btnDownloadTemplate">ğŸ“„ ØªÙ†Ø²ÙŠÙ„ Ù‚Ø§Ù„Ø¨ CSV</button>
            <button class="danger" id="btnClearRoster">ğŸ§¹ Ù…Ø³Ø­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª</button>
          </div>

          <div style="margin-top:10px" id="rosterInfo" class="okBox">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯.</div>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª -->
        <div id="tab_meals" style="display:none">
          <div class="hint">ÙƒÙ„ Ø³Ø·Ø± = ØµÙ†Ù. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© ÙˆØµÙ Ø¨Ø¹Ø¯ | (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</div>
          <label>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ¬Ø¨Ø§Øª</label>
          <textarea id="mealsInp" placeholder="Ø³Ø§Ù†Ø¯ÙˆÙŠØªØ´ Ø¬Ø¨Ù† | Ù…Ø¹ Ø®ÙŠØ§Ø±&#10;ÙØ·ÙŠØ±Ø© Ø²Ø¹ØªØ± | Ø³Ø§Ø®Ù†Ø©"></textarea>

          <div class="btnRow">
            <button class="success" id="btnSaveMeals">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª</button>
            <button class="ghost" id="btnMealsDefault">â†©ï¸ Ø§ÙØªØ±Ø§Ø¶ÙŠ</button>
          </div>

          <div class="hint" style="margin-top:10px">
            Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸: Ø³ØªØ¸Ù‡Ø± Ù„Ù„Ø·Ø§Ù„Ø¨Ø© ÙƒÙ‚Ø§Ø¦Ù…Ø© Ù…Ù†Ø³Ø¯Ù„Ø© Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±.
          </div>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ QR -->
        <div id="tab_qr" style="display:none">
          <div class="card" style="box-shadow:none;border-radius:12px;padding:12px;border:1px solid var(--line);background:#fff">
            <h3 style="margin:0 0 10px">ğŸ“Œ QR Ù„Ù„Ø·Ø§Ù„Ø¨Ø§Øª + Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ù…ÙØ¬Ù‡Ù‘ÙØ²Ø©</h3>
            <div class="row two">
              <div>
                <label>Ø±Ø§Ø¨Ø· ØµÙØ­Ø© Ø§Ù„Ø·Ù„Ø¨ (Ù„Ø¥Ù†Ø´Ø§Ø¡ QR)</label>
                <input id="pageUrl" class="mono" placeholder="https://...">
              </div>
              <div>
                <label>Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ù…ÙØ¬Ù‡Ù‘ÙØ²Ø© (Ù…Ø¹ Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø©)</label>
                <input id="cookWhatsApp" class="mono" placeholder="Ù…Ø«Ø§Ù„: 9689XXXXXXX" inputmode="numeric">
              </div>
            </div>

            <div class="btnRow">
              <button class="primary" id="btnSaveQrWa">ğŸ’¾ Ø­ÙØ¸</button>
              <button class="ghost" id="btnRefreshQr">ğŸ”„ ØªØ­Ø¯ÙŠØ« QR</button>
              <button class="ghost" id="btnCopyUrl">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
            </div>

            <div class="split" style="margin-top:10px">
              <div class="qrBox">
                <canvas id="qrCanvas" width="210" height="210" style="display:block;background:#fff;border-radius:10px"></canvas>
                <div class="hint small" style="margin-top:8px">Ø§Ø·Ø¨Ø¹ÙŠÙ‡ ÙˆØ§Ù„ØµÙ‚ÙŠÙ‡ ÙÙŠ Ù…ÙƒØ§Ù† ÙˆØ§Ø¶Ø­.</div>
              </div>
              <div style="flex:1;min-width:240px">
                <div class="hint small">Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø­Ø§Ù„ÙŠ:</div>
                <div id="qrText" class="mono" style="padding:10px;border:1px solid var(--line);border-radius:10px;background:#f8fafc;word-break:break-all"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
        <div id="tab_settings" style="display:none">
          <div class="hint">ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± ÙˆÙ‚Øª Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ ÙˆØ±Ù…Ø² Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.</div>
          <div class="row two" style="margin-top:10px">
            <div>
              <label>ÙˆÙ‚Øª Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (HH:MM)</label>
              <input id="deadlineInp" class="mono" placeholder="09:00">
            </div>
            <div>
              <label>Ø±Ù…Ø² Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯ (4 Ø£Ø±Ù‚Ø§Ù…)</label>
              <input id="pinInp" class="mono" maxlength="4" placeholder="â€¢â€¢â€¢â€¢" inputmode="numeric">
              <div class="hint small">Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: <span class="mono">1234</span></div>
            </div>
          </div>

          <div class="btnRow">
            <button class="success" id="btnSaveSettings">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
            <button class="ghost" id="btnDefaultsAll">â†©ï¸ Ø§ÙØªØ±Ø§Ø¶ÙŠ</button>
          </div>
        </div>

      </div>
    </div>

  </div>
</div>

<!-- ====== Ù‚Ø§Ù„Ø¨ PDF Ù…Ø®ÙÙŠ ====== -->
<div id="pdfContent" style="position:absolute;left:-99999px;top:0;width:210mm;padding:14mm;background:#fff;color:#111;font-family:Arial,Tahoma;direction:rtl;">
  <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;">
    <div>
      <div style="font-size:18px;font-weight:800">Ù…Ø¯Ø±Ø³Ø© Ø¹Ø§Ø¦Ø´Ø© Ø¨Ù†Øª Ø·Ù„Ø­Ø©</div>
      <div style="font-size:13px;margin-top:4px;color:#333">
        Ø·Ù„Ø¨Ø§Øª ÙˆØ¬Ø¨Ø© Ø§Ù„Ø¥ÙØ·Ø§Ø± â€¢ <span id="pdfDate"></span> â€¢ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚: <span id="pdfDeadline" class="mono"></span>
      </div>
    </div>
    <div style="text-align:left;font-size:12px;color:#333">
      ØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ±: <span id="pdfExportTime" class="mono"></span>
    </div>
  </div>

  <!-- Ø´Ø±ÙŠØ· Ù…Ù„Ø®Øµ Ø§Ø­ØªØ±Ø§ÙÙŠ -->
  <div style="margin-top:12px;border:1px solid #e5e7eb;border-radius:14px;padding:12px;background:#f8fafc;">
    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <div style="flex:1;min-width:150px;border-radius:12px;background:#fff;border:1px solid #e5e7eb;padding:10px;text-align:center;">
        <div style="font-size:12px;color:#666">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
        <div style="font-size:20px;font-weight:800" id="pdfKpiTotal">0</div>
      </div>
      <div style="flex:1;min-width:150px;border-radius:12px;background:#fff;border:1px solid #e5e7eb;padding:10px;text-align:center;">
        <div style="font-size:12px;color:#666">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù</div>
        <div style="font-size:20px;font-weight:800" id="pdfKpiItems">0</div>
      </div>
      <div style="flex:2;min-width:240px;border-radius:12px;background:#fff;border:1px solid #e5e7eb;padding:10px;">
        <div style="font-size:12px;color:#666">Ø§Ù„Ø£ÙƒØ«Ø± Ø·Ù„Ø¨Ù‹Ø§ + Top 3</div>
        <div style="margin-top:6px;font-size:13px" id="pdfTopLine">â€”</div>
      </div>
      <div style="flex:1;min-width:150px;border-radius:12px;background:#fff;border:1px solid #e5e7eb;padding:10px;text-align:center;">
        <div style="font-size:12px;color:#666">Ø¢Ø®Ø± Ø·Ù„Ø¨ (ÙˆÙ‚Øª)</div>
        <div style="font-size:18px;font-weight:800" id="pdfLastTime" class="mono">â€”</div>
      </div>
    </div>
  </div>

  <div style="margin-top:10px;">
    <div style="font-weight:800;margin:8px 0 6px;">Ù…Ù„Ø®Øµ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„ØµÙ†Ù</div>
    <div id="pdfSummary" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
  </div>

  <div style="font-weight:800;margin:10px 0 6px;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
  <table style="width:100%;border-collapse:collapse;font-size:12.5px;">
    <thead>
      <tr>
        <th style="border:1px solid #ddd;padding:6px;">#</th>
        <th style="border:1px solid #ddd;padding:6px;">Ø§Ù„ÙˆÙ‚Øª</th>
        <th style="border:1px solid #ddd;padding:6px;">Ø§Ù„Ø·Ø§Ù„Ø¨Ø©</th>
        <th style="border:1px solid #ddd;padding:6px;">Ø§Ù„ØµÙ</th>
        <th style="border:1px solid #ddd;padding:6px;">Ø§Ù„Ø´Ø¹Ø¨Ø©</th>
        <th style="border:1px solid #ddd;padding:6px;">Ø§Ù„ÙˆØ¬Ø¨Ø§Øª</th>
        <th style="border:1px solid #ddd;padding:6px;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
      </tr>
    </thead>
    <tbody id="pdfTable"></tbody>
  </table>

  <div style="margin-top:10px;font-size:11px;color:#555;">
    Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø®Ø§ØµØ© Ø¨Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ… ÙÙ‚Ø·.
  </div>
</div>

<script>
/* ====== ØªØ®Ø²ÙŠÙ† Ù…Ø­Ù„ÙŠ ====== */
const LS = {
  orders: "tbqa.breakfast.orders.v3",
  roster: "tbqa.breakfast.roster.v1",
  meals:  "tbqa.breakfast.meals.v1",
  settings: "tbqa.breakfast.settings.v3",
  pin: "tbqa.breakfast.pin.v1",
  unlocked: "tbqa.breakfast.unlocked.v1"
};

const DEFAULTS = {
  deadline: "09:00",
  cookWA: "",
  pageUrl: "",
  mealsLines: [
    "Ø³Ø§Ù†Ø¯ÙˆÙŠØªØ´ Ø¬Ø¨Ù† | Ù…Ø¹ Ø®ÙŠØ§Ø±",
    "ÙØ·ÙŠØ±Ø© Ø²Ø¹ØªØ± | Ø³Ø§Ø®Ù†Ø©",
    "ÙƒØ±ÙˆØ§Ø³ÙˆÙ† | Ø¹Ø§Ø¯ÙŠ",
    "Ø­Ù„ÙŠØ¨ | Ø¨Ø§Ø±Ø¯",
    "Ø¹ØµÙŠØ± | Ø¨Ø±ØªÙ‚Ø§Ù„"
  ]
};

function loadJSON(key, fallback){
  try{ const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; }
  catch(e){ return fallback; }
}
function saveJSON(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }

function pad2(n){ return String(n).padStart(2,"0"); }
function todayKey(d=new Date()){
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}
function nowHM(){ const d=new Date(); return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`; }
function nowHMS(){ const d=new Date(); return `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`; }
function timeToMin(hhmm){
  const m = /^(\d{1,2}):(\d{2})$/.exec((hhmm||"").trim());
  if(!m) return null;
  const h=+m[1], mi=+m[2];
  if(h<0||h>23||mi<0||mi>59) return null;
  return h*60 + mi;
}
function nowMin(){ const d=new Date(); return d.getHours()*60 + d.getMinutes(); }
function isOpenNow(){
  const dl = timeToMin(settings.deadline);
  if(dl === null) return true;
  return nowMin() < dl;
}
function unique(arr){ return Array.from(new Set(arr)); }
function toast(msg){ alert(msg); }

/* ====== Ø§Ù„Ø­Ø§Ù„Ø© ====== */
let settings = loadJSON(LS.settings, null) || {...DEFAULTS};
let roster = loadJSON(LS.roster, []) || []; // [{name,grade,section}]
let orders = loadJSON(LS.orders, []) || []; // {date,time,name,grade,section,items[],note}
let mealsLines = loadJSON(LS.meals, null) || (settings.mealsLines || DEFAULTS.mealsLines);
let lastPdfBlob = null;
let lastPdfName = null;

/* ====== Ù‚ÙÙ„ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±ÙØ© ====== */
function getPin(){ return localStorage.getItem(LS.pin) || "1234"; }
function isUnlocked(){ return localStorage.getItem(LS.unlocked) === "1"; }
function setUnlocked(v){ localStorage.setItem(LS.unlocked, v ? "1":"0"); }

function syncAdminUI(){
  const unlocked = isUnlocked();
  document.getElementById("adminLock").style.display = unlocked ? "none":"";
  document.getElementById("adminArea").style.display = unlocked ? "block":"none";
}

/* ====== ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙØ© ====== */
document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    const tab=t.dataset.tab;
    const map = {
      dash:"tab_dash",
      students:"tab_students",
      meals:"tab_meals",
      qr:"tab_qr",
      settings:"tab_settings"
    };
    Object.values(map).forEach(id=>document.getElementById(id).style.display="none");
    document.getElementById(map[tab]).style.display="block";
  });
});

/* ====== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª (Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª) ====== */
const gradeSel = document.getElementById("gradeSel");
const sectionSel = document.getElementById("sectionSel");
const studentSel = document.getElementById("studentSel");
const mealsBtn = document.getElementById("mealsBtn");
const mealsPanel = document.getElementById("mealsPanel");
let qtyMap = {}; // {mealName: qty1to10}
let mealsPanelOpen = false
function renderRosterFilters(){
  const grades = unique(roster.map(r=>r.grade)).sort((a,b)=>String(a).localeCompare(String(b),"ar"));
  gradeSel.innerHTML = `<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„ØµÙ â€”</option>` + grades.map(g=>`<option>${g}</option>`).join("");
  sectionSel.innerHTML = `<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø© â€”</option>`;
  sectionSel.disabled = true;
  studentSel.innerHTML = `<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ø§Ø³Ù… â€”</option>`;
  studentSel.disabled = true;
}

gradeSel.addEventListener("change", ()=>{
  const g = gradeSel.value;
  if(!g){
    sectionSel.disabled = true;
    studentSel.disabled = true;
    sectionSel.innerHTML = `<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø© â€”</option>`;
    studentSel.innerHTML = `<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ø§Ø³Ù… â€”</option>`;
    renderMyOrder();
    return;
  }
  const sections = unique(roster.filter(r=>r.grade===g).map(r=>r.section)).sort((a,b)=>String(a).localeCompare(String(b),"ar"));
  sectionSel.innerHTML = `<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø© â€”</option>` + sections.map(s=>`<option>${s}</option>`).join("");
  sectionSel.disabled = false;
  studentSel.disabled = true;
  studentSel.innerHTML = `<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ø§Ø³Ù… â€”</option>`;
  renderMyOrder();
});

sectionSel.addEventListener("change", ()=>{
  const g = gradeSel.value;
  const s = sectionSel.value;
  if(!g || !s){
    studentSel.disabled = true;
    studentSel.innerHTML = `<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ø§Ø³Ù… â€”</option>`;
    renderMyOrder();
    return;
  }
  const students = roster.filter(r=>r.grade===g && r.section===s).map(r=>r.name).sort((a,b)=>String(a).localeCompare(String(b),"ar"));
  studentSel.innerHTML = `<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ø§Ø³Ù… â€”</option>` + students.map(n=>`<option>${n}</option>`).join("");
  studentSel.disabled = false;
  renderMyOrder();
});

studentSel.addEventListener("change", renderMyOrder);

/* ====== Ø§Ù„ÙˆØ¬Ø¨Ø§Øª (Multi Select + Qty Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©) ====== */
function parseMeals(){
  const lines = (mealsLines || DEFAULTS.mealsLines).map(x=>String(x||"").trim()).filter(Boolean);
  return lines.map(line=>{
    const parts = line.split("|").map(s=>s.trim());
    return {name: parts[0] || "ØµÙ†Ù", desc: parts[1] || ""};
  });
}

function setPanelOpen(open){
  mealsPanelOpen = !!open;
  mealsPanel.style.display = mealsPanelOpen ? 'block' : 'none';
}

function updateMealsBtnLabel(){
  const names = Object.keys(qtyMap).filter(k=>qtyMap[k]);
  if(names.length===0){
    mealsBtn.textContent = 'â€” Ø§Ø®ØªØ± Ø§Ù„ÙˆØ¬Ø¨Ø§Øª â€”';
    return;
  }
  const preview = names.slice(0,2).map(n=>`${n}Ã—${qtyMap[n]||1}`).join('ØŒ ');
  mealsBtn.textContent = names.length<=2 ? preview : `${preview} â€¦ (+${names.length-2})`;
}

function renderMealsPicker(){
  const meals = parseMeals();
  const qtyOptions = Array.from({length:10},(_,i)=>i+1).map(v=>`<option value="${v}">${v}</option>`).join('');

  mealsPanel.innerHTML = meals.map(m=>{
    const checked = (m.name in qtyMap);
    const qty = Number(qtyMap[m.name]||1) || 1;
    const desc = m.desc ? `<span class="desc">${escapeHtml(m.desc)}</span>` : '';
    return `
      <div class="multiRow" data-meal="${escapeHtml(m.name)}">
        <input class="ck" type="checkbox" ${checked?'checked':''} />
        <div class="ttl">
          <div><b>${escapeHtml(m.name)}</b></div>
          ${desc}
        </div>
        <select class="qtySel" ${checked?'':'disabled'}>
          ${qtyOptions}
        </select>
      </div>
    `;
  }).join('');

  // Ø¶Ø¨Ø· Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø­Ø§Ù„ÙŠØ© + Ø§Ù„Ù…Ø³ØªÙ…Ø¹Ø§Øª
  mealsPanel.querySelectorAll('.multiRow').forEach(row=>{
    const meal = row.getAttribute('data-meal');
    const ck = row.querySelector('input.ck');
    const sel = row.querySelector('select.qtySel');
    if(meal in qtyMap) sel.value = String(qtyMap[meal]||1);

    ck.addEventListener('change', ()=>{
      if(ck.checked){
        qtyMap[meal] = qtyMap[meal] || 1
        sel.disabled = false;
        sel.value = String(qtyMap[meal]||1);
      }else{
        delete qtyMap[meal]
        sel.disabled = true;
      }
      updateMealsBtnLabel();
    });

    sel.addEventListener('change', ()=>{
      if(!(meal in qtyMap)) return;
      const v = Number(sel.value||1);
      qtyMap[meal] = (v>=1 && v<=10) ? v : 1;
      updateMealsBtnLabel();
    });
  });

  updateMealsBtnLabel();
}

// ØªÙØ§Ø¹Ù„ ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
mealsBtn.addEventListener('click', (e)=>{
  e.preventDefault();
  setPanelOpen(!mealsPanelOpen);
});

// Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
document.addEventListener('click', (e)=>{
  const wrap = document.getElementById('mealsWrap');
  if(!wrap) return;
  if(!wrap.contains(e.target)) setPanelOpen(false);
});

function clearMealsSelection(){
  qtyMap = {};
  renderMealsPicker();
  setPanelOpen(false);
}

function getSelectedMealsDetailed(){
  return Object.keys(qtyMap).map(name=>({ name, qty: Number(qtyMap[name]||1) || 1 }));
}
/* ====== Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ÙˆÙ‚Øª ====== */
function updateGate(){
  const pill = document.getElementById("gatePill");
  const dl = settings.deadline || DEFAULTS.deadline;
  const open = isOpenNow();
  document.getElementById("deadlineShow").textContent = dl;

  if(open){
    pill.style.borderColor = "";
    pill.style.background = "#f8fafc";
    pill.style.color = "#475569";
    pill.textContent = `âœ… Ø§Ù„Ø·Ù„Ø¨ Ù…ÙØªÙˆØ­ Ø­ØªÙ‰ ${dl} â€” Ø§Ù„Ø¢Ù† ${nowHM()}`;
  }else{
    pill.style.borderColor = "#fecaca";
    pill.style.background = "#fff1f2";
    pill.style.color = "#7f1d1d";
    pill.textContent = `â›” ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¨Ø¹Ø¯ ${dl} â€” Ø§Ù„Ø¢Ù† ${nowHM()}`;
  }
  document.getElementById("btnOrder").disabled = !open;
}

/* ====== Ø·Ù„Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨Ø© ====== */
function findOrderToday(name, grade, section){
  const t = todayKey();
  return orders.find(o=>o.date===t && o.name===name && o.grade===grade && o.section===section) || null;
}

function renderMyOrder(){
  const box = document.getElementById("myOrderBox");
  const grade = gradeSel.value;
  const section = sectionSel.value;
  const name = studentSel.value;

  if(!grade || !section || !name){
    box.className = "hint";
    box.textContent = "Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„ØµÙ ÙˆØ§Ù„Ø´Ø¹Ø¨Ø© ÙˆØ§Ø³Ù…Ùƒ Ù„Ø¹Ø±Ø¶ Ø·Ù„Ø¨Ùƒ Ù‡Ù†Ø§.";
    return;
  }
  const o = findOrderToday(name, grade, section);
  if(!o){
    box.className = "hint";
    box.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨ Ù…Ø³Ø¬Ù„ Ù„Ùƒ Ø§Ù„ÙŠÙˆÙ….";
    return;
  }
  box.className = "okBox";
  box.innerHTML = `
    âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨Ùƒ Ø§Ù„ÙŠÙˆÙ…
    <div style="margin-top:8px" class="hint">
      <b>Ø§Ù„ÙˆØ¬Ø¨Ø§Øª:</b> ${formatItems(o.items).join("ØŒ ")} â€¢ <b>Ø§Ù„ÙˆÙ‚Øª:</b> <span class="mono">${o.time}</span><br>
      <b>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</b> ${o.note ? o.note : "â€”"}
    </div>
  `;
}

document.getElementById("btnOrder").addEventListener("click", ()=>{
  if(!isOpenNow()) return toast("Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø·Ù„Ø¨");

  const grade = gradeSel.value;
  const section = sectionSel.value;
  const name = studentSel.value;
  const items = getSelectedMealsDetailed();
  const note = document.getElementById("note").value.trim();

  if(!grade || !section || !name) return toast("Ø±Ø¬Ø§Ø¡Ù‹ Ø§Ø®ØªØ§Ø±ÙŠ (Ø§Ù„ØµÙ/Ø§Ù„Ø´Ø¹Ø¨Ø©/Ø§Ù„Ø§Ø³Ù…)");
  if(items.length === 0) return toast("Ø±Ø¬Ø§Ø¡Ù‹ Ø§Ø®ØªØ§Ø±ÙŠ ÙˆØ¬Ø¨Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");
  if(findOrderToday(name, grade, section)) return toast("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨Ùƒ Ù…Ø³Ø¨Ù‚Ù‹Ø§ Ø§Ù„ÙŠÙˆÙ….");

  orders.unshift({
    id: (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now())+Math.random().toString(16).slice(2)),
    date: todayKey(),
    time: nowHMS(),
    name, grade, section,
    items,
    note
  });

  saveJSON(LS.orders, orders);
  toast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ âœ…");
  document.getElementById("note").value = "";
  clearMealsSelection();
  qtyMap = {};
  renderAll();
});

document.getElementById("btnClear").addEventListener("click", ()=>{
  gradeSel.value = "";
  sectionSel.value = "";
  studentSel.value = "";
  sectionSel.disabled = true;
  studentSel.disabled = true;
  document.getElementById("note").value = "";
  clearMealsSelection();
  qtyMap = {};
  renderMyOrder();
});

/* ====== Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±ÙØ©: KPI + Ø¬Ø¯ÙˆÙ„ ====== */
function getTodayOrders(){ return orders.filter(o=>o.date===todayKey()); }

function computeCounts(ordersArr){
  const counts = {};
  ordersArr.forEach(o=>{
    (o.items||[]).forEach(it=>{
      // ÙŠØ¯Ø¹Ù… Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ù†Øµ) ÙˆØ§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ({name,qty})
      if(typeof it === 'string'){
        const key = it;
        counts[key] = (counts[key]||0) + 1;
      }else if(it && typeof it === 'object'){
        const key = it.name || it.item || 'ØµÙ†Ù';
        const q = Number(it.qty || it.count || 1) || 1;
        counts[key] = (counts[key]||0) + q;
      }
    });
  });
  return counts;
}
function topItemLine(counts){
  const entries = Object.entries(counts).sort((a,b)=>b[1]-a[1]);
  if(entries.length===0) return { top:"â€”", topLine:"â€”" };
  const top = entries[0][0];
  const top3 = entries.slice(0,3).map(([k,v])=>`${k} Ã— ${v}`).join(" â€¢ ");
  return { top, topLine: `${entries[0][0]} Ã— ${entries[0][1]} | Top 3: ${top3}` };
}

function renderAdminTable(){
  const tb = document.querySelector("#ordersTable tbody");
  const today = getTodayOrders();
  tb.innerHTML = "";

  if(today.length===0){
    tb.innerHTML = `<tr><td colspan="7" style="color:#64748b">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ….</td></tr>`;
  }else{
    today.forEach((o,i)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i+1}</td>
        <td class="mono">${o.time}</td>
        <td>${escapeHtml(o.name)}</td>
        <td>${escapeHtml(o.grade)}</td>
        <td>${escapeHtml(o.section)}</td>
        <td><b>${escapeHtml(formatItems(o.items).join("ØŒ "))}</b></td>
        <td>${escapeHtml(o.note ? o.note : "â€”")}</td>
      `;
      tb.appendChild(tr);
    });
  }

  const counts = computeCounts(today);
  const entries = Object.entries(counts);
  const { top } = topItemLine(counts);

  document.getElementById("kpiTotal").textContent = today.length;
  document.getElementById("kpiItems").textContent = entries.length;
  document.getElementById("kpiTop").textContent = top || "â€”";
}

document.getElementById("btnClearToday").addEventListener("click", ()=>{
  if(!isUnlocked()) return toast("Ø§Ù„Ù„ÙˆØ­Ø© Ù…Ù‚ÙÙ„Ø©");
  if(!confirm("Ù…Ø³Ø­ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ… ÙÙ‚Ø·ØŸ")) return;
  orders = orders.filter(o=>o.date !== todayKey());
  saveJSON(LS.orders, orders);
  renderAll();
});

/* ====== PDF ====== */
function buildPdfContent(){
  const today = getTodayOrders();
  const d = new Date();
  document.getElementById("pdfDate").textContent = `${d.getFullYear()}/${pad2(d.getMonth()+1)}/${pad2(d.getDate())}`;
  document.getElementById("pdfDeadline").textContent = settings.deadline || DEFAULTS.deadline;
  document.getElementById("pdfExportTime").textContent = nowHM();

  const tb = document.getElementById("pdfTable");
  tb.innerHTML = "";

  if(today.length===0){
    tb.innerHTML = `<tr><td colspan="7" style="border:1px solid #ddd;padding:10px;color:#666">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ….</td></tr>`;
  }else{
    today.forEach((o,i)=>{
      tb.innerHTML += `
        <tr>
          <td style="border:1px solid #ddd;padding:6px">${i+1}</td>
          <td style="border:1px solid #ddd;padding:6px" class="mono">${o.time}</td>
          <td style="border:1px solid #ddd;padding:6px">${escapeHtml(o.name)}</td>
          <td style="border:1px solid #ddd;padding:6px">${escapeHtml(o.grade)}</td>
          <td style="border:1px solid #ddd;padding:6px">${escapeHtml(o.section)}</td>
          <td style="border:1px solid #ddd;padding:6px"><b>${escapeHtml(formatItems(o.items).join("ØŒ "))}</b></td>
          <td style="border:1px solid #ddd;padding:6px">${escapeHtml(o.note ? o.note : "â€”")}</td>
        </tr>
      `;
    });
  }

  const counts = computeCounts(today);
  const entries = Object.entries(counts).sort((a,b)=>b[1]-a[1]);

  const sum = document.getElementById("pdfSummary");
  sum.innerHTML = "";
  if(entries.length===0){
    sum.innerHTML = `<div style="padding:8px 10px;border:1px solid #eee;border-radius:999px;background:#fafafa;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ….</div>`;
  }else{
    entries.forEach(([k,v])=>{
      const chip = document.createElement("div");
      chip.style.cssText = "padding:8px 10px;border:1px solid #eee;border-radius:999px;background:#fafafa;font-size:12px;";
      chip.innerHTML = `<b>${escapeHtml(k)}</b> <span style="color:#555">Ã— ${v}</span>`;
      sum.appendChild(chip);
    });
  }

  document.getElementById("pdfKpiTotal").textContent = today.length;
  document.getElementById("pdfKpiItems").textContent = entries.length;
  const { topLine } = topItemLine(counts);
  document.getElementById("pdfTopLine").textContent = topLine || "â€”";
  document.getElementById("pdfLastTime").textContent = today.length ? today[0].time : "â€”";
}

async function makePdfBlob(){
  if(!isUnlocked()) { toast("Ø§Ù„Ù„ÙˆØ­Ø© Ù…Ù‚ÙÙ„Ø©"); return null; }
  buildPdfContent();

  const element = document.getElementById("pdfContent");
  const filename = `Ø·Ù„Ø¨Ø§Øª_Ø§Ù„Ø¥ÙØ·Ø§Ø±_${todayKey()}.pdf`;

  const opt = {
    margin: 0,
    filename,
    image: { type: "jpeg", quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true },
    jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
  };

  const worker = html2pdf().set(opt).from(element);
  const blob = await worker.outputPdf("blob");

  lastPdfBlob = blob;
  lastPdfName = filename;
  return blob;
}

function downloadBlob(blob, filename){
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 800);
}

document.getElementById("btnMakePdf").addEventListener("click", async ()=>{
  const blob = await makePdfBlob();
  if(!blob) return;
  downloadBlob(blob, lastPdfName || `Ø·Ù„Ø¨Ø§Øª_Ø§Ù„Ø¥ÙØ·Ø§Ø±_${todayKey()}.pdf`);
  toast("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ PDF ÙˆØªÙ†Ø²ÙŠÙ„Ù‡ âœ…");
});

/* ====== Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨ ====== */
async function sharePdfOnWhatsApp(){
  const blob = lastPdfBlob || await makePdfBlob();
  if(!blob) return;

  const filename = lastPdfName || `Ø·Ù„Ø¨Ø§Øª_Ø§Ù„Ø¥ÙØ·Ø§Ø±_${todayKey()}.pdf`;
  const file = new File([blob], filename, { type: "application/pdf" });

  try{
    if(navigator.canShare && navigator.canShare({ files: [file] })){
      await navigator.share({
        title: "Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥ÙØ·Ø§Ø±",
        text: `Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥ÙØ·Ø§Ø± Ù„Ù„ÙŠÙˆÙ… ${todayKey()} â€” Ù…Ø¯Ø±Ø³Ø© Ø¹Ø§Ø¦Ø´Ø© Ø¨Ù†Øª Ø·Ù„Ø­Ø©`,
        files: [file]
      });
      return;
    }
  }catch(e){}

  // Ø¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±
  downloadBlob(blob, filename);
  const msg = encodeURIComponent(
    `Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥ÙØ·Ø§Ø± Ù„Ù„ÙŠÙˆÙ… ${todayKey()} â€” Ù…Ø¯Ø±Ø³Ø© Ø¹Ø§Ø¦Ø´Ø© Ø¨Ù†Øª Ø·Ù„Ø­Ø©\n` +
    `âœ… ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ù…Ù„Ù PDFØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø±ÙØ§Ù‚Ù‡ Ù‡Ù†Ø§ ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡.`
  );
  const wa = (settings.cookWA || "").trim();
  const url = wa ? `https://wa.me/${wa}?text=${msg}` : `https://wa.me/?text=${msg}`;
  window.open(url, "_blank");
}
document.getElementById("btnShareWA").addEventListener("click", sharePdfOnWhatsApp);

/* ====== QR ====== */
let qr = null;
function renderQR(){
  const canvas = document.getElementById("qrCanvas");
  const textEl = document.getElementById("qrText");
  const url = (settings.pageUrl || "").trim();
  textEl.textContent = url || "(Ø¶Ø¹ÙŠ Ø±Ø§Ø¨Ø· ØµÙØ­Ø© Ø§Ù„Ø·Ù„Ø¨ Ù‡Ù†Ø§)";

  if(!qr){
    qr = new QRious({ element: canvas, size: 210, value: url || "Ø¶Ø¹ Ø±Ø§Ø¨Ø· ØµÙØ­Ø© Ø§Ù„Ø·Ù„Ø¨ Ù‡Ù†Ø§" });
  }else{
    qr.set({ value: url || "Ø¶Ø¹ Ø±Ø§Ø¨Ø· ØµÙØ­Ø© Ø§Ù„Ø·Ù„Ø¨ Ù‡Ù†Ø§" });
  }
}

document.getElementById("btnSaveQrWa").addEventListener("click", ()=>{
  if(!isUnlocked()) return toast("Ø§Ù„Ù„ÙˆØ­Ø© Ù…Ù‚ÙÙ„Ø©");
  settings.pageUrl = (document.getElementById("pageUrl").value || "").trim();
  settings.cookWA  = (document.getElementById("cookWhatsApp").value || "").trim();
  saveJSON(LS.settings, settings);
  renderQR();
  toast("ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…");
});

document.getElementById("btnRefreshQr").addEventListener("click", renderQR);
document.getElementById("btnCopyUrl").addEventListener("click", async ()=>{
  const url = (settings.pageUrl || "").trim();
  if(!url) return toast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· Ù…Ø­ÙÙˆØ¸");
  try{ await navigator.clipboard.writeText(url); toast("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·"); }
  catch(e){ toast("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ù†Ø³Ø® ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§. Ø§Ù†Ø³Ø®ÙŠ Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ¯ÙˆÙŠÙ‹Ø§."); }
});

/* ====== Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª: Ø§Ø³ØªÙŠØ±Ø§Ø¯ CSV ====== */
function parseCSVText(text){
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  if(lines.length===0) return [];
  const first = lines[0].toLowerCase();
  const startIdx = (first.includes("name") && first.includes("grade") && first.includes("section")) ? 1 : 0;

  const out=[];
  for(let i=startIdx;i<lines.length;i++){
    const parts = lines[i].split(",").map(s=>s.trim());
    if(parts.length < 3) continue;
    const name=parts[0], grade=parts[1], section=parts[2];
    if(!name || !grade || !section) continue;
    out.push({name, grade, section});
  }
  return out;
}
function rosterKey(r){ return `${r.name}__${r.grade}__${r.section}`; }

async function importCSV(){
  if(!isUnlocked()) return toast("Ø§Ù„Ù„ÙˆØ­Ø© Ù…Ù‚ÙÙ„Ø©");
  const f = document.getElementById("csvFile").files?.[0];
  let text = (document.getElementById("csvPaste").value || "").trim();

  if(!text && f) text = await f.text();
  if(!text) return toast("Ø§Ø±ÙØ¹ÙŠ Ù…Ù„Ù CSV Ø£Ùˆ Ø§Ù„ØµÙ‚ÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");

  const data = parseCSVText(text);
  if(data.length===0) return toast("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ù„Ø­Ø©. ØªØ£ÙƒØ¯ÙŠ Ù…Ù† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©: name,grade,section");

  const map = new Map(roster.map(r=>[rosterKey(r), r]));
  data.forEach(r=>map.set(rosterKey(r), r));
  roster = Array.from(map.values());

  saveJSON(LS.roster, roster);
  toast(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯/Ø¯Ù…Ø¬ ${data.length} Ø³Ø¬Ù„ âœ…`);
  renderRosterInfo();
  renderRosterFilters();
}

function downloadTemplate(){
  const tpl = "name,grade,section\nØ¢Ù…Ù†Ø© Ø§Ù„Ù‡Ù†Ø§Ø¦ÙŠØ©,Ø§Ù„Ø³Ø§Ø¨Ø¹,Ø£\nÙ…Ù‡Ø§ Ø§Ù„ÙƒÙ†Ø¯ÙŠØ©,Ø§Ù„Ø³Ø§Ø¨Ø¹,Ø£\n";
  const blob = new Blob([tpl], {type:"text/csv;charset=utf-8"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="template_students.csv";
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 600);
}

function renderRosterInfo(){
  const el = document.getElementById("rosterInfo");
  if(roster.length===0){
    el.className="okBox";
    el.innerHTML = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ø§Ù„Ø¨Ø§Øª Ø¨Ø¹Ø¯.";
    return;
  }
  const grades = unique(roster.map(r=>r.grade)).length;
  const secs = unique(roster.map(r=>`${r.grade}__${r.section}`)).length;
  el.className="okBox";
  el.innerHTML = `âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ <b>${roster.length}</b> Ø·Ø§Ù„Ø¨Ø©
  <div class="hint small">Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ: <b>${grades}</b> â€¢ Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ø¹Ø¨: <b>${secs}</b></div>`;
}

document.getElementById("btnImportCsv").addEventListener("click", importCSV);
document.getElementById("btnDownloadTemplate").addEventListener("click", downloadTemplate);
document.getElementById("btnClearRoster").addEventListener("click", ()=>{
  if(!isUnlocked()) return toast("Ø§Ù„Ù„ÙˆØ­Ø© Ù…Ù‚ÙÙ„Ø©");
  if(!confirm("Ù…Ø³Ø­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ")) return;
  roster = [];
  saveJSON(LS.roster, roster);
  renderRosterInfo();
  renderRosterFilters();
  toast("ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.");
});

/* ====== Ø§Ù„ÙˆØ¬Ø¨Ø§Øª: ØªØ¹Ø¯ÙŠÙ„ ÙˆØ­ÙØ¸ ====== */
document.getElementById("mealsInp").value = (mealsLines||DEFAULTS.mealsLines).join("\n");

document.getElementById("btnSaveMeals").addEventListener("click", ()=>{
  if(!isUnlocked()) return toast("Ø§Ù„Ù„ÙˆØ­Ø© Ù…Ù‚ÙÙ„Ø©");
  const lines = (document.getElementById("mealsInp").value||"")
    .split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  if(lines.length===0) return toast("Ø£Ø¶ÙŠÙÙŠ ÙˆØ¬Ø¨Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");
  mealsLines = lines;
  saveJSON(LS.meals, mealsLines);
  renderMealsPicker();
  toast("ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª âœ…");
});

document.getElementById("btnMealsDefault").addEventListener("click", ()=>{
  if(!isUnlocked()) return toast("Ø§Ù„Ù„ÙˆØ­Ø© Ù…Ù‚ÙÙ„Ø©");
  mealsLines = DEFAULTS.mealsLines.slice();
  saveJSON(LS.meals, mealsLines);
  document.getElementById("mealsInp").value = mealsLines.join("\n");
  renderMealsPicker();
  toast("ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©.");
});

/* ====== Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ====== */
document.getElementById("deadlineInp").value = settings.deadline || DEFAULTS.deadline;

document.getElementById("btnSaveSettings").addEventListener("click", ()=>{
  if(!isUnlocked()) return toast("Ø§Ù„Ù„ÙˆØ­Ø© Ù…Ù‚ÙÙ„Ø©");
  const dl = (document.getElementById("deadlineInp").value||"").trim() || DEFAULTS.deadline;
  if(timeToMin(dl)===null) return toast("ØµÙŠØºØ© Ø§Ù„ÙˆÙ‚Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©. Ù…Ø«Ø§Ù„: 09:00");
  settings.deadline = dl;

  const pin = (document.getElementById("pinInp").value||"").trim();
  if(pin){
    if(!/^\d{4}$/.test(pin)) return toast("Ø±Ù…Ø² Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 4 Ø£Ø±Ù‚Ø§Ù….");
    localStorage.setItem(LS.pin, pin);
    document.getElementById("pinInp").value="";
  }

  saveJSON(LS.settings, settings);
  updateGate();
  toast("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª âœ…");
});

document.getElementById("btnDefaultsAll").addEventListener("click", ()=>{
  if(!isUnlocked()) return toast("Ø§Ù„Ù„ÙˆØ­Ø© Ù…Ù‚ÙÙ„Ø©");
  if(!confirm("Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª + Ø§Ù„ÙˆØ¬Ø¨Ø§Øª)ØŸ")) return;
  settings = {...DEFAULTS};
  mealsLines = DEFAULTS.mealsLines.slice();
  saveJSON(LS.settings, settings);
  saveJSON(LS.meals, mealsLines);
  document.getElementById("deadlineInp").value = settings.deadline;
  document.getElementById("mealsInp").value = mealsLines.join("\n");
  renderMealsPicker();
  renderQR();
  updateGate();
  toast("ØªÙ…Øª Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©.");
});

/* ====== ÙØªØ­/Ù‚ÙÙ„ ====== */
document.getElementById("btnUnlock").addEventListener("click", ()=>{
  const pin = prompt("Ø£Ø¯Ø®Ù„ÙŠ Ø±Ù…Ø² Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ 1234):");
  if(pin === null) return;
  if(String(pin).trim() === getPin()){
    setUnlocked(true);
    syncAdminUI();
    renderAll();
  }else{
    toast("Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­");
  }
});
document.getElementById("btnLock").addEventListener("click", ()=>{
  setUnlocked(false);
  syncAdminUI();
});

/* ====== Ø­Ù…Ø§ÙŠØ© Ø¶Ø¯ XSS Ø¨Ø³ÙŠØ· ====== */
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

function formatItems(itemsArr){
  const out=[];
  (itemsArr||[]).forEach(it=>{
    if(typeof it==='string') out.push(it);
    else if(it && typeof it==='object'){
      const name = it.name || it.item || 'ØµÙ†Ù';
      const q = Number(it.qty || it.count || 1) || 1;
      out.push(`${name} Ã— ${q}`);
    }
  });
  return out;
}

/* ====== Render All ====== */
function renderAll(){
  // ØªØ²Ø§Ù…Ù† Ø­Ù‚ÙˆÙ„ QR/WA
  const pageUrlInp = document.getElementById("pageUrl");
  const cookWAInp  = document.getElementById("cookWhatsApp");
  if(pageUrlInp) pageUrlInp.value = settings.pageUrl || "";
  if(cookWAInp) cookWAInp.value = settings.cookWA || "";

  document.getElementById("deadlineShow").textContent = settings.deadline || DEFAULTS.deadline;
  document.getElementById("deadlineInp").value = settings.deadline || DEFAULTS.deadline;

  renderMealsPicker();
  renderRosterInfo();
  renderRosterFilters();
  renderMyOrder();
  updateGate();
  renderQR();
  if(isUnlocked()) renderAdminTable();
}

/* ØªØ´ØºÙŠÙ„ */
function boot(){
  saveJSON(LS.settings, settings);
  syncAdminUI();
  renderAll();
  setInterval(updateGate, 10000);
}
boot();
</script>

</body>
</html>
